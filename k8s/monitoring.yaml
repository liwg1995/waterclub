apiVersion: v1
kind: ServiceMonitor
metadata:
  name: water-cube-metrics
  namespace: water-cube
  labels:
    app: web
spec:
  selector:
    matchLabels:
      app: web
  endpoints:
  - port: http
    interval: 30s
    path: /metrics

---
apiVersion: v1
kind: PrometheusRule
metadata:
  name: water-cube-alerts
  namespace: water-cube
spec:
  groups:
  - name: water-cube
    interval: 30s
    rules:
    - alert: HighErrorRate
      expr: |
        (sum(rate(django_http_requests_total{status=~"5.."}[5m])) by (instance) /
         sum(rate(django_http_requests_total[5m])) by (instance)) > 0.05
      for: 5m
      annotations:
        summary: "高错误率告警"
        description: "实例 {{ $labels.instance }} 的错误率超过5%"

    - alert: HighMemoryUsage
      expr: |
        container_memory_usage_bytes{pod=~"web-.*"} / 
        container_spec_memory_limit_bytes{pod=~"web-.*"} > 0.8
      for: 5m
      annotations:
        summary: "内存使用率高"
        description: "Pod {{ $labels.pod }} 的内存使用率超过80%"

    - alert: DatabaseConnectionError
      expr: |
        django_db_connection_errors_total{instance=~".*"} > 0
      for: 2m
      annotations:
        summary: "数据库连接错误"
        description: "无法连接到数据库"

    - alert: RedisDown
      expr: |
        up{job="redis"} == 0
      for: 1m
      annotations:
        summary: "Redis服务不可用"
        description: "Redis 实例已离线"
